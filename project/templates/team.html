<html  lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Home</title>
	<link href="{{ url_for('static', filename='../statics/css/bootstrap/bootstrap.css') }} " rel="stylesheet" />
	<link href="{{ url_for('static', filename='../statics/css/bootstrap/bootstrap-theme.css') }} " rel="stylesheet" />
	<script src="{{ url_for('static', filename='../statics/js/jquery-2.1.3.js') }}" /></script>
	<script src="{{ url_for('static', filename='../statics/js/bootstrap/bootstrap.js') }}" /></script>
	<script src="{{ url_for('static', filename='../statics/js/JavaS.js') }}" /></script>
	<script src="{{ url_for('static', filename='../statics/js/jquery.nicescroll.min.js') }}" /></script>
	<link href="{{ url_for('static', filename='../statics/css/style.css') }}" rel="stylesheet" />
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">


</head>

<body>
<ul class=" col-xs-3 col-md-2 leftmenu shadow " id="leftmenu" >

	<li class=" usernameitem " id="usernameitem">
		<a href="/user/home/"><h4 id="getusername" class="leftmenuitem"></h4></a>
	</li>
	<li class=" usernameitem " id="usernameprofitem" style="display:none">
		<h4 id="getusernameprof" class="leftmenuitem">></h4>
		<h4 id="getidprof" style="display:none"></h4>
	</li>

	<li  id="contest"  >

		<a href="/user/contest/" ><h4 class="leftmenuitem"><i  class="fa fa-laptop" style="width:20px; height:20px;"> </i> Contests</h4></a>
	</li>

	<li  id="team"  >
		<a href="/user/team/"><h4 class="leftmenuitem"><i class="fa fa-group" style=" width:20px; height:20px; "></i> Teams</h4></a>
	</li>

	<li  id="users"  >
		<a href="#users"><h4 class="leftmenuitem"><i class="fa fa-user" style="width:20px; height:20px; "></i> Users</h4></a>
	</li>

	<li  id="setting"  >
		<a href="/user/setting/"><h4 class="leftmenuitem"><i class="fa fa-gears" style=" width:20px; height:20px; "></i> Settings</h4></a>
	</li>

	<li  id="logout"   >
		<a href="#logout"><h4 class="leftmenuitem"><i class="fa fa-sign-out" style=" width:20px; height:20px; "></i> Log out</h4></a>
	</li>
	<li  id="backtoprofile" style="display:none" >
		<a href="/user/home/"><h4 class="leftmenuitem"><i class="fa fa-mail-reply"style=" width:20px; height:20px; "></i>Back to profile</h4></a>
	</li>

</ul>
<div class="col-xs-offset-3 col-md-offset-2 row">
	<div class="col-xs-9 col-md-10 maintitr">
		<p id="titlePage">Teams</p>
		<div><a href="#createTeam"><button class="hover-button close-page">Create Team</button></a></div>
	</div>
</div>
<div class="col-xs-offset-3 col-md-offset-2 row">
	<div  class="contents col-lg-9" id="teamPage">

	</div>
	<div  class="contents col-lg-9" id="loneTeamPage"></div>
</div>
<div id="createTeam" class="form-dialog">
	<div id="teamForm">
		<a href="#" title="Close" class="close-button">X</a>
		<div class="question">
			<input id="teamName" type="text" required/>
			<label>Team Name</label>
		</div>
		<div class="question">
			<input id="member1" type="text" required/>
			<label>Member 1</label>
			<p>Optional</p>
		</div>
		<div class="question">
			<input id="member2" type="text" required/>
			<label>Member 2</label>
			<p>Optional</p>
		</div>
		<button id="submitCreateTeam" class="submit-button">Submit</button>
		<div id="ifSuccessfully"></div>
	</div>
</div>




</body>

<script>
	$backToTeamPage = function(){
		$("#loneTeamPage").slideUp(500);
		setTimeout(function(){ $("#teamPage").slideDown(1000); }, 700);
	};
	$editTeam = function(){
		if ($("#editTeamButton").html() == 'Edit')
		{
			$('.editable').each(function(){
				$("#editTeamButton").data("teamName", $(this).html());
				$(this).replaceWith($('<input class="' + $(this).attr('class') + '" value="' + $(this).html() + '" >'));
			});
			var counter = 0;
			$('.removable').each(function(){
				if (counter == 0)
				{
					$(this).data("member", $(this).html());
				}
				else
				{
					$(this).data("member", $(this).html());
				}
				if ($(this).html() != "")
				{
					$(this).html($(this).html() + '<label class="clickable-label">(remove)</label>');
				}
				counter = 1;
			});
			counter = 0;
			$('.addable').each(function(){
				$(this).replaceWith($('<input class="' + $(this).attr('class') + '" value="' + $(this).html() + '" >'));
			});
			$("#editTeamButton").html('Submit');
			$(".clickable-label").click(function(){
				$(this).closest("p").html("");
			});
		}
		else
		{
			counter = 0;
			$('.removable').each(function(){
				if (counter == 0)
				{
					if ($(this).html() == "" && $(this).data("member") != "")
					{
						alert($(this).data("member") + ' removed');
						$(this).addClass('addable').removeClass('removable');
					}
					else
					{
						$(this).html($(this).data("member"));
					}
				}
				else
				{
					if ($(this).html() == "" && $(this).data("member") != "")
					{
						alert($(this).data("member") + ' removed');
						$(this).addClass('addable').removeClass('removable');
					}
					else
					{
						$(this).html($(this).data("member"));
					}
				}
				counter = 1;
			});
			counter = 0;
			$('.addable').each(function(){
				var myData;
				if ($(this).val() != "") {
					$obj = $(this);
					myData = {"name": $("#editTeamButton").data("teamName"), "members": [$(this).val()]};
					$.ajax({
						type: "POST",
						url: '/team/members/',
						dataType: "html",
						contentType: "application/json",
						data: JSON.stringify(myData),
						success: function (data) {
							$obj.replaceWith($('<p class="removable">' + $obj.val() + '</p>'));
							alert($obj.val() + " added");
						},
						error: function (request, status, error) {
							alert(error + request + status);
						}
					});
				}
				else {
					$(this).replaceWith($('<p class="' + $(this).attr('class') + '">' + $(this).val() + '</p>'));
				}
			});
			$('.editable').each(function(){
				if ($(this).val() != $("#editTeamButton").data("teamName"))
				{
					var new_name = $(this).val();
					var myUrl = '/team/change_name/' + $('.idTeam').val() + '/';
					$.ajax({
						type: "PUT",
						url: myUrl,
						dataType: "html",
						contentType: "application/json",
						data: '{"new_name": "' + new_name +'"}',
						success: function(data){
							alert($("#editTeamButton").data("teamName") + " changed");
						},
						error: function (request, status, error){
							alert(error + request + status);
						}
					});
				}
				$(this).replaceWith($('<p class="' + $(this).attr('class') + '">' + $(this).val() + '</p>'));
			});
			$("#editTeamButton").html('Edit');
		}
	};
	$(document).ready(function () {
		$("#loneTeamPage").hide();
		$('.close-page').removeClass('close-page').addClass('open-page');
		$("#logout").click(function() {
			$.ajax({
				type: "GET",
				url : '/user/logout/',
				dataType: "html",
				success: function () {
					window.location.replace("/user/");
				},
				error: function (request, status, error) {
					if(request.status===405){
						alert("Please login first");
					}
				}

			});
		});
		$('#team').css('background-color', '#355C7D');
		$.ajax({
			type: "GET",
			url : '/user/get_profile/',
			dataType: "html",
			success: function(data) {
				$myId = (JSON.parse(data)).id;
				$( '#getusername ' ).html((JSON.parse(data)).username);
				$.ajax({
					type: "GET",
					url : '/user/' + $myId + '/teams/',
					dataType: "html",
					success: function (data) {

						$myDataTeam = (JSON.parse(data)).teams;
						for (var counter = 0; counter < $myDataTeam.length; counter++)
						{
							if ($myDataTeam[counter]["members"].length == 2)
							{
								if ($myDataTeam[counter].owner.id == $myId)
								{
									$myHtml = '<div class="open-page info-team"><div class="body-team"><div class="sector-block-team-middle">' + $myDataTeam[counter].name + '</div><div class="sector-block-team"><div>Users</div><p>' + $myDataTeam[counter].owner.username +' (Admin)</p><p class="removable">' + $myDataTeam[counter].members[0].username + '</p><p class="removable">' + $myDataTeam[counter].members[1].username + '</p></div><div class="sector-block-team"><a href="#">Contest</a> <p>' + $myDataTeam[counter].contests + '</p></div></div><input class="is-admin" type="hidden" value="1"><input class="id-team" type="hidden" value="' + $myDataTeam[counter].id + '"></div>';
								}
								else
								{
									$myHtml = '<div class="open-page info-team"><div class="body-team"><div class="sector-block-team-middle">' + $myDataTeam[counter].name + '</div><div class="sector-block-team"><div>Users</div><p>' + $myDataTeam[counter].owner.username +' (Admin)</p><p>' + $myDataTeam[counter].members[0].username + '</p><p>' + $myDataTeam[counter].members[1].username + '</p></div><div class="sector-block-team"><a href="#">Contest</a> <p>' + $myDataTeam[counter].contests + '</p></div></div><input type="hidden" value="0"></div>';
								}
							}
							else if ($myDataTeam[counter]["members"].length == 1)
							{
								if ($myDataTeam[counter].owner.id == $myId)
								{
									$myHtml = '<div class="open-page info-team"><div class="body-team"><div class="sector-block-team-middle">' + $myDataTeam[counter].name + '</div><div class="sector-block-team"><div>Users</div><p>' + $myDataTeam[counter].owner.username +' (Admin)</p><p class="removable">' + $myDataTeam[counter].members[0].username + '</p><p class="addable"></p></div><div class="sector-block-team"><a href="#">Contest</a> <p>' + $myDataTeam[counter].contests + '</p></div></div><input class="is-admin" type="hidden" value="1"><input class="id-team" type="hidden" value="' + $myDataTeam[counter].id + '"></div>';
								}
								else
								{
									$myHtml = '<div class="open-page info-team"><div class="body-team"><div class="sector-block-team-middle">' + $myDataTeam[counter].name + '</div><div class="sector-block-team"><div>Users</div><p>' + $myDataTeam[counter].owner.username +' (Admin)</p><p>' + $myDataTeam[counter].members[0].username + '</p></div><div class="sector-block-team"><a href="#">Contest</a> <p>' + $myDataTeam[counter].contests + '</p></div></div><input type="hidden" value="0"></div>';
								}
							}
							else
							{
								$myHtml = '<div class="open-page info-team"><div class="body-team"><div class="sector-block-team-middle">' + $myDataTeam[counter].name + '</div><div class="sector-block-team"><div>Users</div><p>' + $myDataTeam[counter].owner.username +' (Admin)</p><p class="addable"></p><p class="addable"></p></div><div class="sector-block-team"><a href="#">Contest</a> <p>' + $myDataTeam[counter].contests + '</p></div></div><input type="hidden" class="is-admin" value="1"><input class="id-team" type="hidden" value="' + $myDataTeam[counter].id + '"></div>';
							}
							$("#teamPage").append($myHtml);
						}
						$(".info-team").click(function(){
							if ($(this).find("input.is-admin").val() == '1')
							{
								var addHtml = '<div class="open-page info-team2"><div class="row header-team"><div class="col-sm-3"><button onclick="$backToTeamPage();" class="hover-button">Back</button></div><div class="col-sm-6"><div><p class="editable">' + $(this).closest("div").find(".sector-block-team-middle").html() + '</p></div></div><div class="col-sm-3"><button id="editTeamButton" onclick="$editTeam();" class="hover-button">Edit</button></div></div><div class="body-team">';
							}
							else
							{
								var addHtml = '<div class="open-page info-team2"><div class="row header-team"><div class="col-sm-3"><button onclick="$backToTeamPage();" class="hover-button">Back</button></div><div class="col-sm-6">' + $(this).closest("div").find(".sector-block-team-middle").html() + '</div><div class="col-sm-3"></div></div><div class="body-team">';
							}
							$(this).find(".sector-block-team").each(function(){
								addHtml += '<div class="sector-block-team2">' + $(this).html() + '</div>';
							});
							addHtml += '<input type="hidden" class="idTeam" value="' + $(this).find("input.id-team").val() + '"></div></div>';
							$("#teamPage").slideUp(1000);
							setTimeout(function(){ $("#loneTeamPage").html(addHtml).slideDown(500); }, 1200);

						});
					},
					error: function (request, status, error) {
						if(request.status===405){
							alert("Please login first");
						}
					}

				});
			},
			error: function(request, status, error) {

			}

		});
		$('#submitCreateTeam').click(function(){
			var teamName = $("#teamName").val();
			var member1 = $("#member1").val();
			var member2 = $("#member2").val();
			if (member1 && member2)
			{
				myData = {"name": teamName, "members": [member1, member2]};
			}
			else if (member1)
			{
				myData = {"name": teamName, "members": [member1]};
			}
			else
			{
				myData = {"name": teamName};
			}
			$.ajax({
				type: "POST",
				url: '/team/create/',
				dataType: "html",
				contentType: "application/json",
				data: JSON.stringify(myData),
				success: function(data){
					$("#teamName").val("");
					$("#member1").val("");
					$("#member2").val("");
					$("#submitCreateTeam").hide();
					$("#ifSuccessfully").html("Your team successfully created.");
					setTimeout(function(){ window.location = "/user/team/"; }, 1000);
				},
				error: function (request, status, error){
					alert(status);
				}
			});
		});
	});
</script>
</html>

